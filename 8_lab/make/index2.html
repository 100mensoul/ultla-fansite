<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>つくるページ | ULTLAラボ</title>
  <link rel="stylesheet" href="../../style.css">
  <style>
    /* 既存のスタイルはそのまま保持 */
    
    .detail-header {
      background: linear-gradient(135deg, var(--ultla-blue) 0%, #007BB8 100%);
      color: white;
      padding: var(--spacing-2xl) 0;
      margin-bottom: var(--spacing-2xl);
      position: relative;
      overflow: hidden;
    }
    
    .detail-header::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 30% 40%, rgba(255,255,255,0.15) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(0,163,217,0.3) 0%, transparent 40%);
      z-index: 1;
    }
    
    .detail-header .container {
      position: relative;
      z-index: 2;
    }
    
    .detail-title {
      font-size: clamp(2rem, 5vw, 3rem);
      margin-bottom: var(--spacing-sm);
      font-weight: 500;
    }
    
    .detail-subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: var(--spacing-lg);
    }
    
    .detail-meta {
      display: flex;
      gap: var(--spacing-lg);
      flex-wrap: wrap;
      font-size: 0.95rem;
    }
    
    .meta-item {
      background: rgba(255,255,255,0.2);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-md);
      backdrop-filter: blur(10px);
    }

    /* 認証状態表示 */
    .auth-section {
      background: var(--bg-card);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      text-align: center;
    }

    .login-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .logout-btn {
      background: var(--ultla-red);
      color: white;
      border: none;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.9rem;
      transition: all var(--transition-fast);
    }

    .logout-btn:hover {
      background: #c92a2a;
    }

    .login-prompt {
      color: var(--text-secondary);
    }

    .login-link {
      color: var(--ultla-blue);
      text-decoration: none;
      font-weight: 500;
    }

    .login-link:hover {
      color: var(--ultla-green);
    }

    /* 議事録投稿セクション */
    .upload-section {
      background: var(--bg-card);
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 2px dashed var(--border-light);
      transition: all var(--transition-normal);
      display: none; /* 初期状態では非表示 */
    }
    
    .upload-section.show {
      display: block;
    }
    
    .upload-section.dragover {
      border-color: var(--ultla-blue);
      background: rgba(0,163,217,0.05);
    }
    
    .upload-form {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .form-group {
      margin-bottom: var(--spacing-md);
    }
    
    .form-group label {
      display: block;
      margin-bottom: var(--spacing-xs);
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: var(--spacing-sm);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color var(--transition-fast);
    }
    
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--ultla-blue);
      box-shadow: 0 0 0 3px rgba(0,163,217,0.1);
    }
    
    .file-drop-zone {
      border: 2px dashed var(--border-light);
      border-radius: var(--radius-lg);
      padding: var(--spacing-2xl);
      text-align: center;
      transition: all var(--transition-normal);
      cursor: pointer;
      margin-bottom: var(--spacing-md);
    }
    
    .file-drop-zone.dragover {
      border-color: var(--ultla-blue);
      background: rgba(0,163,217,0.05);
    }
    
    .file-info {
      background: var(--bg-light);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-top: var(--spacing-sm);
      display: none;
    }
    
    .submit-btn {
      background: linear-gradient(135deg, var(--ultla-blue), var(--ultla-green));
      color: white;
      padding: var(--spacing-md) var(--spacing-xl);
      border: none;
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-md);
      width: 100%;
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .submit-btn:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* タスク抽出プレビュー */
    .task-preview-section {
      background: #f8f9ff;
      border: 2px dashed var(--ultla-blue);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-top: var(--spacing-md);
      display: none;
    }

    .task-preview-section.show {
      display: block;
    }

    .task-preview-title {
      color: var(--ultla-blue);
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .task-item {
      background: white;
      padding: var(--spacing-sm);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-xs);
      border-left: 4px solid var(--ultla-green);
    }

    .meeting-item {
      background: white;
      padding: var(--spacing-sm);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-xs);
      border-left: 4px solid var(--ultla-blue);
    }

    .decision-item {
      background: white;
      padding: var(--spacing-sm);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-xs);
      border-left: 4px solid var(--ultla-red);
    }

    .item-content {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .item-meta {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* 検索・フィルター - 既存コードと統合 */
    .search-filter-section {
      background: var(--bg-card);
      padding: var(--spacing-xl);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-xl);
      box-shadow: var(--shadow-md);
    }
    
    .search-container {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      flex-wrap: wrap;
    }
    
    .search-input {
      flex: 1;
      min-width: 250px;
      padding: var(--spacing-md);
      border: 2px solid var(--border-light);
      border-radius: var(--radius-md);
      font-size: 1rem;
      transition: border-color var(--transition-normal);
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--ultla-blue);
    }
    
    .search-btn {
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--ultla-blue);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 500;
      cursor: pointer;
      transition: background var(--transition-normal);
    }
    
    .search-btn:hover {
      background: var(--ultla-green);
    }
    
    /* タグフィルター */
    .tag-filters {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      margin-bottom: var(--spacing-md);
    }
    
    .tag-filter {
      padding: var(--spacing-xs) var(--spacing-sm);
      background: var(--bg-light);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-full);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all var(--transition-fast);
      user-select: none;
    }
    
    .tag-filter:hover {
      background: rgba(0,163,217,0.1);
      border-color: var(--ultla-blue);
    }
    
    .tag-filter.active {
      background: var(--ultla-blue);
      color: white;
      border-color: var(--ultla-blue);
    }
    
    .tag-filter.category {
      background: var(--ultla-green);
      color: white;
      border-color: var(--ultla-green);
    }
    
    .tag-filter.area {
      background: var(--ultla-blue);
      color: white;
      border-color: var(--ultla-blue);
    }
    
    .tag-filter.theme {
      background: var(--ultla-red);
      color: white;
      border-color: var(--ultla-red);
    }
    
    /* 議事録カード - 既存デザインを保持 */
    .minutes-grid {
      display: grid;
      gap: var(--spacing-lg);
    }
    
    .minutes-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
      transition: all var(--transition-normal);
      position: relative;
    }
    
    .minutes-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .minutes-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--spacing-md);
    }
    
    .minutes-date {
      font-size: 0.9rem;
      color: var(--text-muted);
      background: var(--bg-light);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
    }
    
    .minutes-title {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }
    
    .minutes-participants {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
    }
    
    .minutes-content {
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: var(--spacing-md);
    }
    
    .minutes-tags {
      display: flex;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      margin-bottom: var(--spacing-md);
    }
    
    .minutes-tag {
      font-size: 0.75rem;
      padding: 2px var(--spacing-xs);
      border-radius: var(--radius-sm);
      font-weight: 500;
    }
    
    .tag-area { background: rgba(0,163,217,0.1); color: var(--ultla-blue); }
    .tag-category { background: rgba(0,184,148,0.1); color: var(--ultla-green); }
    .tag-theme { background: rgba(255,107,107,0.1); color: var(--ultla-red); }
    .tag-program { background: rgba(108,99,255,0.1); color: #6C63FF; }

    /* 抽出タスク表示 */
    .extracted-tasks {
      background: rgba(0,163,217,0.05);
      border: 1px solid rgba(0,163,217,0.2);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .extracted-tasks-title {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--ultla-blue);
      margin-bottom: var(--spacing-sm);
    }

    .extracted-task-item {
      background: white;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      margin-bottom: var(--spacing-xs);
      font-size: 0.8rem;
    }

    .extracted-task-item:last-child {
      margin-bottom: 0;
    }
    
    .minutes-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .view-detail-btn {
      color: var(--ultla-blue);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      transition: color var(--transition-fast);
    }
    
    .view-detail-btn:hover {
      color: var(--ultla-green);
    }
    
    .view-detail-btn::after {
      content: "→";
      transition: transform var(--transition-fast);
    }
    
    .view-detail-btn:hover::after {
      transform: translateX(2px);
    }

    .edit-btn, .delete-btn {
      padding: var(--spacing-xs) var(--spacing-sm);
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 0.8rem;
      margin-left: var(--spacing-xs);
      transition: all var(--transition-fast);
    }

    .edit-btn {
      background: var(--ultla-blue);
      color: white;
    }

    .edit-btn:hover {
      background: var(--ultla-green);
    }

    .delete-btn {
      background: var(--ultla-red);
      color: white;
    }

    .delete-btn:hover {
      background: #c92a2a;
    }
    
    /* 結果表示 */
    .results-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-md);
      background: var(--bg-light);
      border-radius: var(--radius-md);
    }
    
    .results-count {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .sort-select {
      padding: var(--spacing-xs) var(--spacing-sm);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      background: white;
    }

    /* ローディング・エラー表示 */
    .loading-message {
      text-align: center;
      padding: var(--spacing-2xl);
      color: var(--text-muted);
    }

    .error-message {
      background: #fee;
      border: 1px solid #fcc;
      color: #a00;
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
    }

    .success-message {
      background: #efe;
      border: 1px solid #cfc;
      color: #090;
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
    }

    /* タスク抽出ボタン */
    .preview-btn {
      background: var(--ultla-green);
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      cursor: pointer;
      margin-left: var(--spacing-sm);
      transition: all var(--transition-fast);
    }

    .preview-btn:hover {
      background: #00a86b;
    }
    
    /* レスポンシブ */
    @media (max-width: 768px) {
      .login-status {
        flex-direction: column;
        gap: var(--spacing-sm);
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .search-input {
        min-width: unset;
      }
      
      .minutes-header {
        flex-direction: column;
        gap: var(--spacing-sm);
      }
      
      .results-info {
        flex-direction: column;
        gap: var(--spacing-sm);
        text-align: center;
      }
      
      .tag-filters {
        justify-content: center;
      }

      .minutes-actions {
        flex-direction: column;
        gap: var(--spacing-sm);
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>ULTLAラボ</h1>
      <nav>
        <a href="../../1_news/index.html">ニュース</a>
        <a href="../../2_about/index.html">ULTLAとは</a>
        <a href="../../3_people/index.html">ULTLA人</a>
        <a href="../../4_map/index.html">マップ</a>
        <a href="../../5_recipe/index.html">レシピ</a>
        <a href="../../6_chat/index.html">チャット</a>
        <a href="../../7_mypage/index.html">自分学</a>
        <a href="../index.html">ラボ</a>
        <a href="../../9_archive/index.html">アーカイブ</a>
        <a href="../../10_contact/index.html">お問い合わせ</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- プログラム詳細ヘッダー -->
    <section class="detail-header">
      <div class="container">
        <h1 class="detail-title">つくるページ</h1>
        <p class="detail-subtitle">ULTLAプログラムの制作プロセスを可視化する実験室</p>
        <div class="detail-meta">
          <span class="meta-item">📋 全議事録管理</span>
          <span class="meta-item">🔍 横断検索対応</span>
          <span class="meta-item">🏷️ タグ分類システム</span>
          <span class="meta-item">🤖 AI タスク抽出</span>
          <span class="meta-item">📊 プロセス可視化</span>
        </div>
      </div>
    </section>

    <div class="container">
      <!-- 認証状態表示 -->
      <section class="auth-section">
        <div id="authStatus">
          <!-- ログイン状態 -->
          <div id="loggedInStatus" style="display: none;">
            <div class="login-status">
              <div class="user-info">
                <span style="color: var(--ultla-green); font-weight: bold;">✅ ログイン中:</span>
                <span id="currentUser"></span>
              </div>
              <button id="logoutBtn" class="logout-btn">ログアウト</button>
            </div>
            <button id="showUploadBtn" class="search-btn" style="margin-bottom: var(--spacing-md);">📝 新しい議事録を投稿</button>
          </div>
          
          <!-- 未ログイン状態 -->
          <div id="notLoggedInStatus" style="display: none;">
            <div class="login-prompt">
              <p style="margin-bottom: var(--spacing-sm);">⚠️ ログインしていません</p>
              <p>議事録の投稿・編集にはログインが必要です。</p>
              <a href="../auth-test.html" class="login-link">ログインページへ →</a>
            </div>
          </div>
        </div>
      </section>

      <!-- メッセージ表示エリア -->
      <div id="messageArea"></div>

      <!-- 議事録投稿セクション -->
      <section id="uploadSection" class="upload-section">
        <div class="section-header">
          <h2 class="section-title">📁 議事録投稿</h2>
          <p class="section-subtitle">会議の記録をプロジェクトメンバーと共有しましょう</p>
        </div>

        <form class="upload-form" id="uploadForm">
          <div class="form-group">
            <label for="meetingTitle">会議タイトル <span style="color: var(--ultla-red);">*</span></label>
            <input type="text" id="meetingTitle" required placeholder="例：第3回 海エリア企画会議">
          </div>

          <div class="form-group">
            <label for="meetingDate">会議日付 <span style="color: var(--ultla-red);">*</span></label>
            <input type="date" id="meetingDate" required>
          </div>

          <div class="form-group">
            <label for="meetingParticipants">参加者</label>
            <input type="text" id="meetingParticipants" placeholder="例：田中、佐藤、鎌倉市・山田氏">
          </div>

          <div class="form-group">
            <label for="meetingDescription">内容・概要 <span style="color: var(--ultla-red);">*</span></label>
            <textarea id="meetingDescription" rows="6" required placeholder="会議の内容や主要な決定事項など

例：
TODO: チラシデザインを田中さんが9月15日まで作成
担当: 佐藤さん
締切: 来週まで

会場予約について確認する必要がある
決定事項: 参加費を3000円に設定
次回会議: 9月20日 15:00〜"></textarea>
            <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-xs);">
              <button type="button" id="previewTasksBtn" class="preview-btn">🤖 タスク抽出プレビュー</button>
              <small style="color: var(--text-muted); align-self: center;">※投稿前にどんなタスクが抽出されるか確認できます</small>
            </div>
          </div>

          <!-- タスク抽出プレビュー -->
          <div id="taskPreviewSection" class="task-preview-section">
            <div class="task-preview-title">
              🤖 抽出されるタスク・スケジュール
            </div>
            <div id="taskPreviewContent">
              <!-- プレビュー内容がここに表示されます -->
            </div>
          </div>

          <div class="form-group">
            <label for="meetingTags">タグ（カンマ区切り）</label>
            <input type="text" id="meetingTags" placeholder="例：海,事務,広報,コマ1">
            <small style="color: var(--text-muted);">💡 エリア（海・森）、カテゴリ（事務・広報）、テーマ、プログラム（コマ1-4・全体）など</small>
          </div>

          <div class="form-group">
            <label for="meetingFile">議事録ファイル（任意）</label>
            <div class="file-drop-zone" id="fileDropZone">
              <p>📄 ファイルをドラッグ&ドロップするか、クリックして選択</p>
              <p style="color: var(--text-muted); font-size: 0.9rem;">対応形式: PDF, Word, Excel, PowerPoint, テキスト</p>
            </div>
            <input type="file" id="meetingFile" style="display: none;" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.md">
            <div class="file-info" id="fileInfo"></div>
          </div>

          <div style="display: flex; gap: var(--spacing-md);">
            <button type="submit" class="submit-btn" id="submitBtn" disabled>
              📤 議事録を投稿
            </button>
            <button type="button" id="cancelUploadBtn" class="submit-btn" style="background: var(--text-muted); flex: 0 0 auto;">
              キャンセル
            </button>
          </div>
        </form>
      </section>

      <!-- 検索・フィルター -->
      <section class="search-filter-section">
        <div class="search-container">
          <input type="text" class="search-input" placeholder="議事録を検索（フリーワード）" id="searchInput">
          <button class="search-btn" onclick="performSearch()">検索</button>
        </div>
        
        <div class="tag-filters">
          <span class="tag-filter active" data-tag="all">すべて</span>
          <span class="tag-filter area" data-tag="海">海</span>
          <span class="tag-filter area" data-tag="森">森</span>
          <span class="tag-filter category" data-tag="広報">広報</span>
          <span class="tag-filter category" data-tag="事務">事務</span>
          <span class="tag-filter theme" data-tag="身体">身体</span>
          <span class="tag-filter theme" data-tag="霊性">霊性</span>
          <span class="tag-filter theme" data-tag="発散">発散</span>
          <span class="tag-filter theme" data-tag="収束">収束</span>
          <span class="tag-filter theme" data-tag="内省">内省</span>
          <span class="tag-filter program" data-tag="コマ1">コマ1</span>
          <span class="tag-filter program" data-tag="コマ2">コマ2</span>
          <span class="tag-filter program" data-tag="コマ3">コマ3</span>
          <span class="tag-filter program" data-tag="コマ4">コマ4</span>
          <span class="tag-filter program" data-tag="全体">全体</span>
        </div>
      </section>

      <!-- 検索結果情報 -->
      <div class="results-info">
        <span class="results-count" id="resultsCount">議事録を読み込み中...</span>
        <select class="sort-select" id="sortSelect" onchange="sortResults()">
          <option value="date-desc">新しい順</option>
          <option value="date-asc">古い順</option>
          <option value="relevance">関連度順</option>
        </select>
      </div>

      <!-- 議事録カード一覧 -->
      <section class="minutes-grid" id="minutesGrid">
        <div class="loading-message">議事録を読み込んでいます...</div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">
      <small>© 2025 ULTLA Fan Community</small>
    </div>
  </footer>

  <!-- Firebase設定 -->
  <script type="module" src="../firebase-test.js"></script>
  
  <!-- 議事録管理機能 - タスク抽出統合版 -->
  <script type="module">
    import { db, storage, authReady, auth } from '../firebase-test.js';
    import {
      collection,
      addDoc,
      serverTimestamp,
      query,
      where,
      orderBy,
      onSnapshot,
      doc,
      getDoc,
      setDoc,
      getDocs,
      updateDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
    import {
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // タスク抽出エンジンをインライン化（本来は外部ファイルから読み込み）
    function extractTasksAndSchedules(content, title = '', meetingDate = new Date()) {
      const result = {
        tasks: [],
        meetings: [],
        decisions: []
      };

      if (!content || typeof content !== 'string') {
        return result;
      }

      const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
      
      // Level 1: 明示的パターンの抽出
      result.tasks.push(...extractExplicitTasks(lines, meetingDate));
      result.meetings.push(...extractMeetings(lines, meetingDate));
      result.decisions.push(...extractDecisions(lines));
      
      // Level 2: 自然言語パターンの抽出
      const remainingText = lines.join(' ');
      result.tasks.push(...extractNaturalLanguageTasks(remainingText, meetingDate));
      
      // 重複削除
      result.tasks = deduplicateTasks(result.tasks);
      result.meetings = deduplicateMeetings(result.meetings);
      result.decisions = deduplicateDecisions(result.decisions);
      
      return result;
    }

    function extractExplicitTasks(lines, meetingDate) {
      const tasks = [];
      const taskPatterns = [
        /^TODO[：:]\s*(.+)/i,
        /^やること[：:]\s*(.+)/i,
        /^タスク[：:]\s*(.+)/i,
        /^[⬜☐□▢]\s*(.+)/,
        /^[-*]\s*\[\s*\]\s*(.+)/,
        /^担当[：:]\s*(.+)/,
        /^責任者[：:]\s*(.+)/,
        /^締切[：:]\s*(.+)/,
        /^期限[：:]\s*(.+)/,
        /^期日[：:]\s*(.+)/,
        /^まで[：:]\s*(.+)/
      ];

      let currentTask = null;
      
      for (const line of lines) {
        let matched = false;
        
        for (const pattern of taskPatterns) {
          const match = line.match(pattern);
          if (match) {
            const content = match[1].trim();
            
            if (pattern.source.includes('担当') || pattern.source.includes('責任者')) {
              if (currentTask) {
                currentTask.assignee = extractAssignee(content);
              }
            } else if (pattern.source.includes('締切') || pattern.source.includes('期限') || pattern.source.includes('まで')) {
              if (currentTask) {
                currentTask.deadline = extractDeadline(content, meetingDate);
                currentTask.deadlineText = content;
              }
            } else {
              currentTask = {
                id: generateTaskId(),
                content: content,
                type: 'task',
                status: 'todo',
                priority: 'medium',
                assignee: null,
                deadline: null,
                deadlineText: null,
                source: 'explicit',
                createdAt: new Date()
              };
              
              const assigneeMatch = content.match(/(.+?)[を|が]\s*([^\s]+?)[さん|氏|君]?[が|は]\s*(.+)/);
              if (assigneeMatch) {
                currentTask.content = assigneeMatch[1].trim() + assigneeMatch[3].trim();
                currentTask.assignee = assigneeMatch[2].trim();
              }
              
              const deadlineMatch = content.match(/(.+?)\s*([0-9]+月[0-9]+日|来週|今週|今月|来月|[0-9]+日まで)/);
              if (deadlineMatch) {
                currentTask.content = deadlineMatch[1].trim();
                currentTask.deadline = extractDeadline(deadlineMatch[2], meetingDate);
                currentTask.deadlineText = deadlineMatch[2];
              }
              
              tasks.push(currentTask);
            }
            matched = true;
            break;
          }
        }
        
        if (!matched) {
          currentTask = null;
        }
      }
      
      return tasks;
    }

    function extractNaturalLanguageTasks(text, meetingDate) {
      const tasks = [];
      
      // 強化版: より柔軟な動詞パターン
      const enhancedActionPatterns = [
        // 基本パターン（既存）
        /([^\s。、]+?)([さん|氏|君]?)が\s*([^\s。、]+?)[を|に]\s*(確認|調整|検討|準備|作成|実施|対応|連絡)[する|します|した]?/g,
        
        // 新しい柔軟なパターン
        /([^\s。、]+?)[が|は]\s*([^\s。、]+?)[を|に]\s*(実装|開発|作成|準備|確認|調整|検討|実施|対応|連絡)[する|します|してもらう]/g,
        
        // 期限付きタスクパターン
        /(明日|今日|今週|来週|[0-9]+日|[0-9]+月[0-9]+日)までに[、,]?\s*([^\s。、]+?)[が|は]?\s*([^\s。、]+?)[を|に]\s*(実装|開発|作成|準備|確認|調整|検討|実施|対応|連絡)/g,
        
        // ヒアリング・相談パターン
        /([^\s。、]+?)から\s*([^\s。、]+?)[を|に|について]\s*(ヒアリング|相談|確認|聞く)/g,
        
        // 依頼パターン
        /([^\s。、]+?)[に|へ]\s*([^\s。、]+?)[を|について]\s*(依頼|お願い|要請)/g
      ];
      
      for (const pattern of enhancedActionPatterns) {
        let match;
        while ((match = pattern.exec(text)) !== null) {
          let assignee = null;
          let content = match[0].trim();
          let deadline = null;
          let deadlineText = null;
          let priority = 'medium';
          
          // パターン別の処理
          if (pattern.source.includes('までに')) {
            // 期限付きパターン
            deadlineText = match[1];
            deadline = extractDeadline(match[1], meetingDate);
            assignee = extractAssignee(match[2]);
            content = `${match[3]}${match[4]}`;
            
            // 期限による優先度判定
            if (match[1].includes('今日') || match[1].includes('明日')) {
              priority = 'high';
            }
          } else if (pattern.source.includes('から')) {
            // ヒアリングパターン
            assignee = extractAssignee(match[1]);
            content = `${match[2]}について${match[3]}`;
          } else if (pattern.source.includes('に|へ')) {
            // 依頼パターン
            assignee = extractAssignee(match[1]);
            content = `${match[2]}を${match[3]}`;
          } else {
            // 基本パターン
            assignee = extractAssignee(match[1]);
          }
          
          // 緊急度キーワードチェック
          if (content.includes('緊急') || content.includes('急ぎ') || content.includes('今すぐ') || content.includes('ASAP')) {
            priority = 'urgent';
          }
          
          const task = {
            id: generateTaskId(),
            content: content,
            type: 'task',
            status: 'todo',
            priority: priority,
            assignee: assignee,
            deadline: deadline,
            deadlineText: deadlineText,
            source: 'natural_language_enhanced',
            createdAt: new Date()
          };
          
          tasks.push(task);
        }
      }
      
      return tasks;
    }

    function extractMeetings(lines, meetingDate) {
      const meetings = [];
      const meetingPatterns = [
        /^次回[会議|ミーティング|打ち合わせ][：:]\s*(.+)/i,
        /^会議[予定|日程][：:]\s*(.+)/i,
        /^[0-9]+月[0-9]+日.*[0-9]+[：:][0-9]+.*[会議|ミーティング|打ち合わせ]/i
      ];
      
      for (const line of lines) {
        for (const pattern of meetingPatterns) {
          const match = line.match(pattern);
          if (match) {
            const meeting = {
              id: generateTaskId(),
              title: '会議予定',
              content: match[1] || match[0],
              type: 'meeting',
              date: extractMeetingDate(match[1] || match[0], meetingDate),
              source: 'explicit',
              createdAt: new Date()
            };
            meetings.push(meeting);
          }
        }
      }
      
      return meetings;
    }

    function extractDecisions(lines) {
      const decisions = [];
      const decisionPatterns = [
        /^決定[事項]?[：:]\s*(.+)/i,
        /^決まったこと[：:]\s*(.+)/i,
        /^合意[事項]?[：:]\s*(.+)/i
      ];
      
      for (const line of lines) {
        for (const pattern of decisionPatterns) {
          const match = line.match(pattern);
          if (match) {
            const decision = {
              id: generateTaskId(),
              content: match[1].trim(),
              type: 'decision',
              createdAt: new Date()
            };
            decisions.push(decision);
          }
        }
      }
      
      return decisions;
    }

    function extractAssignee(text) {
      const cleaned = text.replace(/さん|氏|君|様/g, '').trim();
      const names = cleaned.split(/[、,・]/);
      return names[0].trim();
    }

    function extractDeadline(text, baseDate) {
      const now = new Date(baseDate);
      
      const dateMatch = text.match(/([0-9]+)月([0-9]+)日/);
      if (dateMatch) {
        const month = parseInt(dateMatch[1]);
        const day = parseInt(dateMatch[2]);
        const year = month >= now.getMonth() + 1 ? now.getFullYear() : now.getFullYear() + 1;
        return new Date(year, month - 1, day);
      }
      
      if (text.includes('今日')) {
        return new Date(now);
      } else if (text.includes('明日')) {
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        return tomorrow;
      } else if (text.includes('今週')) {
        const endOfWeek = new Date(now);
        endOfWeek.setDate(endOfWeek.getDate() + (7 - endOfWeek.getDay()));
        return endOfWeek;
      } else if (text.includes('来週')) {
        const nextWeek = new Date(now);
        nextWeek.setDate(nextWeek.getDate() + 7);
        return nextWeek;
      } else if (text.includes('今月')) {
        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        return endOfMonth;
      } else if (text.includes('来月')) {
        const nextMonth = new Date(now.getFullYear(), now.getMonth() + 2, 0);
        return nextMonth;
      }
      
      return null;
    }

    function extractMeetingDate(text, baseDate) {
      const dateMatch = text.match(/([0-9]+)月([0-9]+)日/);
      if (dateMatch) {
        const month = parseInt(dateMatch[1]);
        const day = parseInt(dateMatch[2]);
        const year = month >= baseDate.getMonth() + 1 ? baseDate.getFullYear() : baseDate.getFullYear() + 1;
        
        const timeMatch = text.match(/([0-9]+)[：:]([0-9]+)/);
        if (timeMatch) {
          const hour = parseInt(timeMatch[1]);
          const minute = parseInt(timeMatch[2]);
          return new Date(year, month - 1, day, hour, minute);
        }
        
        return new Date(year, month - 1, day);
      }
      
      return null;
    }

    function deduplicateTasks(tasks) {
      const seen = new Set();
      return tasks.filter(task => {
        const key = `${task.content}_${task.assignee || 'none'}`;
        if (seen.has(key)) {
          return false;
        }
        seen.add(key);
        return true;
      });
    }

    function deduplicateMeetings(meetings) {
      const seen = new Set();
      return meetings.filter(meeting => {
        const key = `${meeting.content}_${meeting.date?.getTime() || 'none'}`;
        if (seen.has(key)) {
          return false;
        }
        seen.add(key);
        return true;
      });
    }

    function deduplicateDecisions(decisions) {
      const seen = new Set();
      return decisions.filter(decision => {
        if (seen.has(decision.content)) {
          return false;
        }
        seen.add(decision.content);
        return true;
      });
    }

    function generateTaskId() {
      return 'task_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
    }

    // グローバル変数
    let currentUID = null;
    let userProfile = null;
    let selectedFile = null;
    let allMeetingRecords = [];
    let extractedData = null; // プレビュー用

    // DOM要素
    const loggedInStatus = document.getElementById('loggedInStatus');
    const notLoggedInStatus = document.getElementById('notLoggedInStatus');
    const currentUser = document.getElementById('currentUser');
    const logoutBtn = document.getElementById('logoutBtn');
    const showUploadBtn = document.getElementById('showUploadBtn');
    const uploadSection = document.getElementById('uploadSection');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const messageArea = document.getElementById('messageArea');
    const minutesGrid = document.getElementById('minutesGrid');
    const resultsCount = document.getElementById('resultsCount');
    const previewTasksBtn = document.getElementById('previewTasksBtn');
    const taskPreviewSection = document.getElementById('taskPreviewSection');
    const taskPreviewContent = document.getElementById('taskPreviewContent');

    // HTMLエスケープ関数
    function escapeHTML(str) {
      if (typeof str !== 'string') return '';
      return str.replace(/[&<>"']/g, function (match) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        }[match];
      });
    }

    // 結果件数更新
    function updateResultsCount(count) {
      if (resultsCount) {
        resultsCount.textContent = `${count}件の議事録が見つかりました`;
      }
    }

    // ユーザープロフィール取得
    async function getUserProfile(uid) {
      if (!uid) return null;
      try {
        const profileRef = doc(db, "userProfiles", uid);
        const profileSnap = await getDoc(profileRef);
        return profileSnap.exists() ? profileSnap.data() : null;
      } catch (error) {
        console.error("プロフィール取得エラー:", error);
        return null;
      }
    }

    // 認証状態表示更新
    async function updateAuthDisplay(user) {
      if (user) {
        currentUID = user.uid;
        userProfile = await getUserProfile(user.uid);
        
        let displayText;
        if (userProfile && userProfile.username) {
          displayText = `${userProfile.username}さん`;
        } else {
          const email = user.email || `匿名ユーザー (${user.uid.substring(0, 8)}...)`;
          displayText = email;
        }
        
        const authMethod = user.isAnonymous ? '匿名' : (user.providerData[0]?.providerId === 'google.com' ? 'Google' : 'メール');
        currentUser.innerHTML = `${displayText} <small style="color: #666;">(${authMethod}認証)</small>`;
        
        loggedInStatus.style.display = 'block';
        notLoggedInStatus.style.display = 'none';
      } else {
        currentUID = null;
        userProfile = null;
        loggedInStatus.style.display = 'none';
        notLoggedInStatus.style.display = 'block';
      }
    }

    // メッセージ表示
    function showMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `${type}-message`;
      messageDiv.textContent = message;
      messageArea.innerHTML = '';
      messageArea.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    // ログアウト処理
    async function handleLogout() {
      try {
        await signOut(auth);
        showMessage('ログアウトしました', 'success');
        setTimeout(() => {
          window.location.href = '../auth-test.html';
        }, 1000);
      } catch (error) {
        console.error("ログアウトエラー:", error);
        showMessage('ログアウトに失敗しました: ' + error.message, 'error');
      }
    }

    // 議事録アップロード表示/非表示
    function toggleUploadSection() {
      if (uploadSection.classList.contains('show')) {
        uploadSection.classList.remove('show');
        showUploadBtn.textContent = '📝 新しい議事録を投稿';
        taskPreviewSection.classList.remove('show');
      } else {
        uploadSection.classList.add('show');
        showUploadBtn.textContent = '📝 投稿フォームを閉じる';
        document.getElementById('meetingDate').value = new Date().toISOString().split('T')[0];
      }
    }

    // タスク抽出プレビュー
    function previewTasks() {
      const title = document.getElementById('meetingTitle').value.trim();
      const content = document.getElementById('meetingDescription').value.trim();
      const dateValue = document.getElementById('meetingDate').value;
      const meetingDate = dateValue ? new Date(dateValue) : new Date();

      if (!content) {
        showMessage('内容・概要を入力してからプレビューしてください', 'error');
        return;
      }

      console.log('=== タスク抽出プレビュー開始 ===');
      console.log('タイトル:', title);
      console.log('内容:', content);
      console.log('会議日:', meetingDate);

      extractedData = extractTasksAndSchedules(content, title, meetingDate);
      
      console.log('抽出結果:', extractedData);

      // プレビュー表示
      let previewHTML = '';
      
      if (extractedData.tasks.length > 0) {
        previewHTML += '<div style="margin-bottom: 1rem;"><h4 style="color: var(--ultla-green); margin-bottom: 0.5rem;">📋 タスク (' + extractedData.tasks.length + '件)</h4>';
        extractedData.tasks.forEach(task => {
          previewHTML += `
            <div class="task-item">
              <div class="item-content">${escapeHTML(task.content)}</div>
              <div class="item-meta">
                ${task.assignee ? `担当: ${escapeHTML(task.assignee)} | ` : ''}
                ${task.deadline ? `期限: ${task.deadline.toLocaleDateString('ja-JP')} | ` : ''}
                抽出方法: ${task.source === 'explicit' ? '明示的' : '自然言語'}
              </div>
            </div>
          `;
        });
        previewHTML += '</div>';
      }

      if (extractedData.meetings.length > 0) {
        previewHTML += '<div style="margin-bottom: 1rem;"><h4 style="color: var(--ultla-blue); margin-bottom: 0.5rem;">📅 会議・スケジュール (' + extractedData.meetings.length + '件)</h4>';
        extractedData.meetings.forEach(meeting => {
          previewHTML += `
            <div class="meeting-item">
              <div class="item-content">${escapeHTML(meeting.content)}</div>
              <div class="item-meta">
                ${meeting.date ? `日時: ${meeting.date.toLocaleString('ja-JP')}` : '日時未設定'}
              </div>
            </div>
          `;
        });
        previewHTML += '</div>';
      }

      if (extractedData.decisions.length > 0) {
        previewHTML += '<div style="margin-bottom: 1rem;"><h4 style="color: var(--ultla-red); margin-bottom: 0.5rem;">✅ 決定事項 (' + extractedData.decisions.length + '件)</h4>';
        extractedData.decisions.forEach(decision => {
          previewHTML += `
            <div class="decision-item">
              <div class="item-content">${escapeHTML(decision.content)}</div>
            </div>
          `;
        });
        previewHTML += '</div>';
      }

      if (previewHTML === '') {
        previewHTML = '<p style="color: var(--text-muted); text-align: center;">タスクやスケジュールが検出されませんでした。<br>明示的な形式（TODO: など）で記述すると抽出精度が向上します。</p>';
      }

      taskPreviewContent.innerHTML = previewHTML;
      taskPreviewSection.classList.add('show');

      showMessage('タスク抽出が完了しました！', 'success');
    }

    // ファイル選択処理
    const fileDropZone = document.getElementById('fileDropZone');
    const meetingFile = document.getElementById('meetingFile');
    const fileInfo = document.getElementById('fileInfo');
    const submitBtn = document.getElementById('submitBtn');

    fileDropZone.addEventListener('click', () => meetingFile.click());

    fileDropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileDropZone.classList.add('dragover');
    });

    fileDropZone.addEventListener('dragleave', () => {
      fileDropZone.classList.remove('dragover');
    });

    fileDropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      fileDropZone.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileSelect(files[0]);
      }
    });

    meetingFile.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });

    function handleFileSelect(file) {
      selectedFile = file;
      fileInfo.style.display = 'block';
      fileInfo.innerHTML = `
        <h4>選択されたファイル:</h4>
        <p><strong>名前:</strong> ${file.name}</p>
        <p><strong>サイズ:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
        <p><strong>種類:</strong> ${file.type || '不明'}</p>
      `;
      updateSubmitButton();
    }

    function updateSubmitButton() {
      const title = document.getElementById('meetingTitle').value.trim();
      const date = document.getElementById('meetingDate').value;
      const description = document.getElementById('meetingDescription').value.trim();
      
      if (title && date && description) {
        submitBtn.disabled = false;
      } else {
        submitBtn.disabled = true;
      }
    }

    // フォーム入力監視
    document.getElementById('meetingTitle').addEventListener('input', updateSubmitButton);
    document.getElementById('meetingDate').addEventListener('input', updateSubmitButton);
    document.getElementById('meetingDescription').addEventListener('input', updateSubmitButton);

    // 議事録投稿処理（タスク抽出統合版）
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentUID) {
        showMessage('ログインが必要です', 'error');
        return;
      }

      const formData = {
        title: document.getElementById('meetingTitle').value.trim(),
        meetingDate: new Date(document.getElementById('meetingDate').value),
        participants: document.getElementById('meetingParticipants').value.trim() || '',
        description: document.getElementById('meetingDescription').value.trim(),
        tags: document.getElementById('meetingTags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '')
      };

      submitBtn.disabled = true;
      submitBtn.textContent = '📤 投稿中...';

      try {
        let fileUrl = '';
        let fileName = '';
        let fileSize = 0;
        let fileType = '';

        // ファイルアップロード処理
        if (selectedFile) {
          const fileStorageName = `meeting_records/${currentUID}_${Date.now()}_${selectedFile.name}`;
          const fileRef = ref(storage, fileStorageName);
          const snapshot = await uploadBytes(fileRef, selectedFile);
          fileUrl = await getDownloadURL(snapshot.ref);
          fileName = selectedFile.name;
          fileSize = selectedFile.size;
          fileType = selectedFile.type;
        }

        // タスク抽出（プレビューがあればそれを使用、なければ新規抽出）
        let extractedTasks = extractedData;
        if (!extractedTasks) {
          extractedTasks = extractTasksAndSchedules(formData.description, formData.title, formData.meetingDate);
        }

        console.log('=== 投稿時タスク抽出結果 ===');
        console.log(extractedTasks);

        // Firestoreに保存
        const recordData = {
          uid: currentUID,
          uploaderName: userProfile ? userProfile.displayName : '匿名ユーザー',
          title: formData.title,
          meetingDate: formData.meetingDate,
          participants: formData.participants,
          description: formData.description,
          tags: formData.tags,
          fileUrl,
          fileName,
          fileSize,
          fileType,
          project: 'ULTLA2025',
          status: 'published',
          // 抽出されたタスク・スケジュール情報を追加
          extractedTasks: extractedTasks.tasks,
          extractedMeetings: extractedTasks.meetings,
          extractedDecisions: extractedTasks.decisions,
          taskExtractionVersion: '1.0', // 抽出エンジンのバージョン
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        const docRef = await addDoc(collection(db, "meetingRecords"), recordData);
        
        // 抽出されたタスクを個別にprojectTasksコレクションに保存
        if (extractedTasks.tasks.length > 0) {
          for (const task of extractedTasks.tasks) {
            const taskData = {
              ...task,
              meetingRecordId: docRef.id,
              meetingTitle: formData.title,
              uid: currentUID,
              project: 'ULTLA2025',
              createdAt: serverTimestamp()
            };
            await addDoc(collection(db, "projectTasks"), taskData);
          }
        }

        // 会議情報も保存
        if (extractedTasks.meetings.length > 0) {
          for (const meeting of extractedTasks.meetings) {
            const meetingData = {
              ...meeting,
              meetingRecordId: docRef.id,
              uid: currentUID,
              project: 'ULTLA2025',
              createdAt: serverTimestamp()
            };
            await addDoc(collection(db, "projectSchedules"), meetingData);
          }
        }
        
        showMessage(`議事録が投稿されました！（タスク${extractedTasks.tasks.length}件、会議${extractedTasks.meetings.length}件を抽出）`, 'success');
        
        // フォームリセット
        document.getElementById('uploadForm').reset();
        selectedFile = null;
        extractedData = null;
        fileInfo.style.display = 'none';
        taskPreviewSection.classList.remove('show');
        toggleUploadSection();
        updateSubmitButton();

      } catch (error) {
        console.error('投稿エラー:', error);
        showMessage('投稿に失敗しました: ' + error.message, 'error');
      } finally {
        submitBtn.textContent = '📤 議事録を投稿';
      }
    });

    // 議事録一覧表示（デバッグ強化版）
    function displayMeetingRecords() {
      console.log('=== 議事録読み込み開始 ===');
      
      try {
        const recordsRef = collection(db, "meetingRecords");
        console.log('Collection参照作成成功');
        
        onSnapshot(recordsRef, (querySnapshot) => {
          console.log('=== Firestore応答受信 ===');
          console.log('取得件数:', querySnapshot.size);
          
          allMeetingRecords = [];
          
          querySnapshot.forEach((doc) => {
            const record = doc.data();
            console.log('ドキュメントID:', doc.id);
            console.log('ドキュメントデータ:', record);
            
            allMeetingRecords.push({
              id: doc.id,
              ...record
            });
          });
          
          console.log('全議事録データ:', allMeetingRecords);
          
          // プロジェクトフィルタリング
          const filteredRecords = allMeetingRecords.filter(record => 
            record.project === 'ULTLA2025'
          );
          
          console.log('ULTLA2025フィルター後:', filteredRecords);
          
          // 日付ソート
          filteredRecords.sort((a, b) => {
            const dateA = a.meetingDate?.toDate ? a.meetingDate.toDate() : new Date(a.meetingDate);
            const dateB = b.meetingDate?.toDate ? b.meetingDate.toDate() : new Date(b.meetingDate);
            return dateB - dateA;
          });
          
          console.log('ソート後:', filteredRecords);
          
          // 表示処理
          renderMeetingRecords(filteredRecords);
          updateResultsCount(filteredRecords.length);
          
        }, (error) => {
          console.error("=== Firestore読み込みエラー ===");
          console.error("エラー詳細:", error);
          console.error("エラーコード:", error.code);
          console.error("エラーメッセージ:", error.message);
          
          minutesGrid.innerHTML = `
            <div class="error-message">
              議事録の読み込みに失敗しました<br>
              エラー: ${error.message}<br>
              <button onclick="window.debugDisplayRecords()" style="margin-top: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 4px;">再試行</button>
            </div>
          `;
        });
        
      } catch (error) {
        console.error('=== クエリ作成エラー ===');
        console.error(error);
        minutesGrid.innerHTML = `
          <div class="error-message">
            クエリの作成に失敗しました: ${error.message}
          </div>
        `;
      }
    }

    // 議事録カード描画（タスク抽出結果表示対応版）
    function renderMeetingRecords(records) {
      console.log('=== レンダリング開始 ===');
      console.log('レンダリング対象件数:', records.length);
      
      if (records.length === 0) {
        console.log('表示する議事録がありません');
        minutesGrid.innerHTML = '<div class="loading-message">議事録がまだありません</div>';
        return;
      }

      minutesGrid.innerHTML = '';
      
      records.forEach((record, index) => {
        console.log(`カード作成中 ${index + 1}/${records.length}:`, record.title);
        
        try {
          const cardElement = createMeetingRecordCard(record);
          minutesGrid.appendChild(cardElement);
          console.log(`カード作成成功: ${record.title}`);
        } catch (error) {
          console.error(`カード作成エラー (${record.title}):`, error);
        }
      });
      
      console.log('=== レンダリング完了 ===');
    }

    // 議事録カード作成（タスク表示対応版）
    function createMeetingRecordCard(record) {
      console.log('カード作成開始:', record);
      
      const element = document.createElement('article');
      element.className = 'minutes-card';
      element.setAttribute('data-tags', record.tags ? record.tags.join(',') : '');

      let meetingDate;
      try {
        meetingDate = record.meetingDate ? 
          (record.meetingDate.toDate ? record.meetingDate.toDate() : new Date(record.meetingDate)) :
          new Date();
      } catch (dateError) {
        console.error('日付変換エラー:', dateError);
        meetingDate = new Date();
      }

      const isOwner = record.uid === currentUID;
      
      // 抽出されたタスク・スケジュール情報の表示準備
      let extractedContentHTML = '';
      if (record.extractedTasks && record.extractedTasks.length > 0) {
        extractedContentHTML += `
          <div class="extracted-tasks">
            <div class="extracted-tasks-title">🤖 抽出されたタスク (${record.extractedTasks.length}件)</div>
            ${record.extractedTasks.slice(0, 3).map(task => `
              <div class="extracted-task-item">
                📋 ${escapeHTML(task.content)}
                ${task.assignee ? ` (担当: ${escapeHTML(task.assignee)})` : ''}
                ${task.deadline ? ` (期限: ${new Date(task.deadline.seconds * 1000).toLocaleDateString('ja-JP')})` : ''}
              </div>
            `).join('')}
            ${record.extractedTasks.length > 3 ? `<div class="extracted-task-item" style="color: var(--text-muted);">...他${record.extractedTasks.length - 3}件</div>` : ''}
          </div>
        `;
      }

      if (record.extractedMeetings && record.extractedMeetings.length > 0) {
        extractedContentHTML += `
          <div class="extracted-tasks" style="border-color: rgba(0,163,217,0.2);">
            <div class="extracted-tasks-title">📅 抽出された会議 (${record.extractedMeetings.length}件)</div>
            ${record.extractedMeetings.map(meeting => `
              <div class="extracted-task-item">
                📅 ${escapeHTML(meeting.content)}
                ${meeting.date ? ` (${new Date(meeting.date.seconds * 1000).toLocaleString('ja-JP')})` : ''}
              </div>
            `).join('')}
          </div>
        `;
      }

      if (record.extractedDecisions && record.extractedDecisions.length > 0) {
        extractedContentHTML += `
          <div class="extracted-tasks" style="border-color: rgba(255,107,107,0.2);">
            <div class="extracted-tasks-title">✅ 決定事項 (${record.extractedDecisions.length}件)</div>
            ${record.extractedDecisions.map(decision => `
              <div class="extracted-task-item">
                ✅ ${escapeHTML(decision.content)}
              </div>
            `).join('')}
          </div>
        `;
      }

      element.innerHTML = `
        <div class="minutes-header">
          <div>
            <h3 class="minutes-title">${escapeHTML(record.title || '無題')}</h3>
            ${record.participants ? `<p class="minutes-participants">参加者: ${escapeHTML(record.participants)}</p>` : ''}
          </div>
          <span class="minutes-date">${meetingDate.toLocaleDateString('ja-JP')}</span>
        </div>
        
        <div class="minutes-content">
          ${escapeHTML(record.description || '内容なし')}
        </div>
        
        ${record.tags && record.tags.length > 0 ? `
          <div class="minutes-tags">
            ${record.tags.map(tag => {
              let tagClass = 'tag-theme';
              if (['海', '森'].includes(tag)) tagClass = 'tag-area';
              else if (['事務', '広報'].includes(tag)) tagClass = 'tag-category';
              else if (['コマ1', 'コマ2', 'コマ3', 'コマ4', '全体'].includes(tag)) tagClass = 'tag-program';
              
              return `<span class="minutes-tag ${tagClass}">${escapeHTML(tag)}</span>`;
            }).join('')}
          </div>
        ` : ''}
        
        ${extractedContentHTML}
        
        <div class="minutes-actions">
          <div>
            ${record.fileUrl ? `<a href="${record.fileUrl}" target="_blank" class="view-detail-btn">📄 ファイルを開く</a>` : ''}
          </div>
          <div>
            <small style="color: var(--text-muted);">投稿者: ${escapeHTML(record.uploaderName || '不明')}</small>
            ${isOwner ? `
              <button class="edit-btn" onclick="editRecord('${record.id}')">編集</button>
              <button class="delete-btn" onclick="deleteRecord('${record.id}')">削除</button>
            ` : ''}
          </div>
        </div>
      `;

      return element;
    }

    // 検索・フィルター機能
    window.performSearch = function() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      if (!searchTerm.trim()) {
        renderMeetingRecords(allMeetingRecords.filter(record => record.project === 'ULTLA2025'));
        updateResultsCount(allMeetingRecords.filter(record => record.project === 'ULTLA2025').length);
        return;
      }

      const filteredRecords = allMeetingRecords.filter(record => {
        if (record.project !== 'ULTLA2025') return false;
        const searchableText = `${record.title} ${record.description} ${record.participants || ''} ${(record.tags || []).join(' ')}`.toLowerCase();
        return searchableText.includes(searchTerm);
      });

      renderMeetingRecords(filteredRecords);
      updateResultsCount(filteredRecords.length);
    };

    // タグフィルター
    function filterByTag(tag) {
      if (tag === 'all') {
        const filteredRecords = allMeetingRecords.filter(record => record.project === 'ULTLA2025');
        renderMeetingRecords(filteredRecords);
        updateResultsCount(filteredRecords.length);
        return;
      }

      const filteredRecords = allMeetingRecords.filter(record => {
        return record.project === 'ULTLA2025' && record.tags && record.tags.includes(tag);
      });

      renderMeetingRecords(filteredRecords);
      updateResultsCount(filteredRecords.length);
    }

    // タグフィルターイベント
    document.querySelectorAll('.tag-filter').forEach(tag => {
      tag.addEventListener('click', function() {
        document.querySelectorAll('.tag-filter').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        const selectedTag = this.dataset.tag;
        filterByTag(selectedTag);
      });
    });

    // ソート機能
    window.sortResults = function() {
      const sortBy = document.getElementById('sortSelect').value;
      const currentRecords = [...allMeetingRecords].filter(record => record.project === 'ULTLA2025');
      
      currentRecords.sort((a, b) => {
        if (sortBy === 'date-desc') {
          const dateA = a.meetingDate?.toDate ? a.meetingDate.toDate() : new Date(a.meetingDate);
          const dateB = b.meetingDate?.toDate ? b.meetingDate.toDate() : new Date(b.meetingDate);
          return dateB - dateA;
        } else if (sortBy === 'date-asc') {
          const dateA = a.meetingDate?.toDate ? a.meetingDate.toDate() : new Date(a.meetingDate);
          const dateB = b.meetingDate?.toDate ? b.meetingDate.toDate() : new Date(b.meetingDate);
          return dateA - dateB;
        }
        return 0;
      });
      
      renderMeetingRecords(currentRecords);
    };

    // グローバル関数（編集・削除用）
    window.editRecord = function(recordId) {
      showMessage('編集機能は開発中です', 'info');
    };

    window.deleteRecord = function(recordId) {
      if (confirm('この議事録を削除しますか？\n※この操作は取り消せません。')) {
        deleteDoc(doc(db, "meetingRecords", recordId))
          .then(() => {
            showMessage('議事録が削除されました', 'success');
          })
          .catch((error) => {
            console.error('削除エラー:', error);
            showMessage('削除に失敗しました', 'error');
          });
      }
    };

    // イベントリスナー設定
    logoutBtn.addEventListener('click', handleLogout);
    showUploadBtn.addEventListener('click', toggleUploadSection);
    cancelUploadBtn.addEventListener('click', toggleUploadSection);
    previewTasksBtn.addEventListener('click', previewTasks);

    // 検索入力でEnterキー対応
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    // 認証完了後の処理（デバッグ強化版）
    authReady.then(async (user) => {
      console.log("=== 認証完了 ===");
      console.log("ユーザー:", user);
      
      await updateAuthDisplay(user);
      
      // データベース接続テスト
      console.log("=== データベース接続テスト ===");
      try {
        const testRef = collection(db, "meetingRecords");
        const testQuery = query(testRef);
        const testSnapshot = await getDocs(testQuery);
        console.log("データベース接続成功、総件数:", testSnapshot.size);
        
        testSnapshot.forEach(doc => {
          const data = doc.data();
          console.log("テストデータ:", doc.id, data.project, data.title);
        });
        
      } catch (dbError) {
        console.error("データベース接続エラー:", dbError);
      }
      
      // 議事録一覧を表示
      console.log("=== 議事録表示開始 ===");
      displayMeetingRecords();
      
      // URLパラメータでのフィルタリング処理（遅延実行）
      setTimeout(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const filterTag = urlParams.get('filter');
        if (filterTag && filterTag !== 'all') {
          console.log("URLパラメータフィルター適用:", filterTag);
          filterByTag(filterTag);
        }
      }, 2000); // 少し長めに待機
      
    }).catch(error => {
      console.error("=== 認証処理エラー ===");
      console.error(error);
      updateAuthDisplay(null);
      minutesGrid.innerHTML = '<div class="error-message">認証中にエラーが発生しました</div>';
    });

    // グローバル関数として公開（デバッグ用）
    window.debugDisplayRecords = displayMeetingRecords;
    window.debugAllRecords = () => console.log('All records:', allMeetingRecords);
    window.testTaskExtraction = () => {
      const sampleText = `
第3回企画会議の議事録

TODO: チラシデザインを田中さんが9月15日まで作成
担当: 佐藤さん
締切: 来週まで

会場予約について確認する必要がある
山田さんが音響設備を調整します

決定事項: 参加費を3000円に設定
次回会議: 9月20日 15:00〜

⬜ 資料準備
⬜ 告知文作成
`;

      const result = extractTasksAndSchedules(sampleText, '第3回企画会議', new Date('2025-09-01'));
      console.log('=== タスク抽出テスト結果 ===');
      console.log('タスク:', result.tasks);
      console.log('会議:', result.meetings);
      console.log('決定事項:', result.decisions);
      return result;
    };

    console.log("=== タスク抽出統合版読み込み完了 ===");
    console.log("テスト用関数: window.testTaskExtraction()");
  </script>
</body>
</html>
