<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ­ã‚°ã‚¤ãƒ³ - ULTLAãƒ©ãƒœ</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro W3', 'Hiragino Kaku Gothic Pro', Meiryo, 'ãƒ¡ã‚¤ãƒªã‚ª', Osaka, 'ï¼­ï¼³ ï¼°ã‚´ã‚·ãƒƒã‚¯', 'MS PGothic', sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
      color: #333;
    }

    .container {
      max-width: 400px;
      margin: 50px auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }

    .auth-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background-color: #fafafa;
    }

    .auth-section h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #555;
    }

    .auth-button {
      width: 100%;
      padding: 12px;
      margin-bottom: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s ease;
    }

    .google-btn {
      background-color: #4285f4;
      color: white;
    }

    .google-btn:hover {
      background-color: #357ae8;
    }

    .email-btn {
      background-color: #28a745;
      color: white;
    }

    .email-btn:hover {
      background-color: #218838;
    }

    .anonymous-btn {
      background-color: #6c757d;
      color: white;
    }

    .anonymous-btn:hover {
      background-color: #5a6268;
    }

    .status-message {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }

    .status-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .status-info {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .user-info {
      background-color: #e2f3ff;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      display: none;
    }

    .user-info h4 {
      margin-top: 0;
      color: #0066cc;
    }

    .user-info p {
      margin: 5px 0;
      word-break: break-all;
    }

    .logout-btn {
      background-color: #dc3545;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      font-size: 14px;
    }

    .logout-btn:hover {
      background-color: #c82333;
    }

    .email-form {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 4px;
    }

    .email-form input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .email-form button {
      width: 48%;
      padding: 8px;
      margin-right: 4%;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .email-form button:last-child {
      margin-right: 0;
    }

    .login-btn {
      background-color: #007bff;
      color: white;
    }

    .register-btn {
      background-color: #28a745;
      color: white;
    }

    .back-link {
      text-align: center;
      margin-top: 30px;
    }

    .back-link a {
      color: #007bff;
      text-decoration: none;
    }

    .back-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ³ ULTLAãƒ©ãƒœ ãƒ­ã‚°ã‚¤ãƒ³</h1>
    
    <div id="statusMessage" class="status-message"></div>
    
    <div id="loginSection">
      <div class="auth-section">
        <h3>ğŸ”‘ ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã‚’é¸æŠ</h3>
        
        <button id="googleLoginBtn" class="auth-button google-btn">
          ğŸ“§ Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³
        </button>
        
        <button id="emailToggleBtn" class="auth-button email-btn">
          âœ‰ï¸ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²
        </button>
        
        <div id="emailForm" class="email-form">
          <input type="email" id="emailInput" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" />
          <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
          <button id="loginEmailBtn" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
          <button id="registerEmailBtn" class="register-btn">æ–°è¦ç™»éŒ²</button>
        </div>
        
        <button id="anonymousLoginBtn" class="auth-button anonymous-btn">
          ğŸ‘¤ åŒ¿åã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãŠè©¦ã—ç”¨ï¼‰
        </button>
        <p style="font-size: 0.8em; color: #666; margin-top: 5px; line-height: 1.3;">
          â€»åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã¯ãŠè©¦ã—ç”¨ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šä¿å­˜ã¯ä¿è¨¼ã•ã‚Œã¾ã›ã‚“ã€‚<br>
          æœ¬æ ¼çš„ãªåˆ©ç”¨ã«ã¯æ­£å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚
        </p>
      </div>
    </div>
    
    <div id="userInfo" class="user-info">
      <h4>âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼</h4>
      <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID:</strong> <span id="userId"></span></p>
      <p><strong>èªè¨¼æ–¹æ³•:</strong> <span id="authProvider"></span></p>
      <p><strong>ãƒ¡ãƒ¼ãƒ«:</strong> <span id="userEmail"></span></p>
      <p><strong>è¡¨ç¤ºå:</strong> <span id="displayName"></span></p>
      <button id="logoutBtn" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div class="back-link">
      <a href="make/index2.html">â† ã¤ãã‚‹ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
    </div>
  </div>

  <script type="module" src="firebase-test.js"></script>
  <script type="module">
    // ULTLAãƒ©ãƒœç”¨èªè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    import { auth } from './firebase-test.js';
    import {
      signInWithPopup,
      GoogleAuthProvider,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signInAnonymously,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // DOMè¦ç´ ã®å–å¾—
    const statusMessage = document.getElementById('statusMessage');
    const loginSection = document.getElementById('loginSection');
    const userInfo = document.getElementById('userInfo');

    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const emailToggleBtn = document.getElementById('emailToggleBtn');
    const emailForm = document.getElementById('emailForm');
    const anonymousLoginBtn = document.getElementById('anonymousLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginEmailBtn = document.getElementById('loginEmailBtn');
    const registerEmailBtn = document.getElementById('registerEmailBtn');

    const userId = document.getElementById('userId');
    const authProvider = document.getElementById('authProvider');
    const userEmail = document.getElementById('userEmail');
    const displayName = document.getElementById('displayName');

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showStatus(message, type = 'info') {
      statusMessage.textContent = message;
      statusMessage.className = `status-message status-${type}`;
      statusMessage.style.display = 'block';
      
      setTimeout(() => {
        statusMessage.style.display = 'none';
      }, 5000);
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayUserInfo(user) {
      console.log('ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user);
      
      loginSection.style.display = 'none';
      userInfo.style.display = 'block';
      
      userId.textContent = user.uid;
      userEmail.textContent = user.email || 'æœªè¨­å®š';
      displayName.textContent = user.displayName || 'æœªè¨­å®š';
      
      // èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’åˆ¤å®š
      let provider = 'ä¸æ˜';
      if (user.isAnonymous) {
        provider = 'åŒ¿åèªè¨¼';
      } else if (user.providerData && user.providerData.length > 0) {
        const providerInfo = user.providerData[0];
        switch (providerInfo.providerId) {
          case 'google.com':
            provider = 'Google';
            break;
          case 'password':
            provider = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹';
            break;
          default:
            provider = providerInfo.providerId;
        }
      }
      authProvider.textContent = provider;
      
      showStatus(`${provider}ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼`, 'success');
      
      // ULTLAãƒ©ãƒœã®ã¤ãã‚‹ãƒšãƒ¼ã‚¸ã«è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      let countdown = 3;
      const redirectMessage = document.createElement('p');
      redirectMessage.style.textAlign = 'center';
      redirectMessage.style.color = '#007bff';
      redirectMessage.style.fontWeight = 'bold';
      redirectMessage.style.marginTop = '15px';
      redirectMessage.innerHTML = `<span id="countdown">${countdown}</span>ç§’å¾Œã«ã¤ãã‚‹ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...<br><button id="redirectNow" style="margin-top: 10px; padding: 5px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ä»Šã™ãç§»å‹•</button>`;
      
      userInfo.appendChild(redirectMessage);
      
      // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³å‡¦ç†
      const countdownElement = document.getElementById('countdown');
      const redirectNowBtn = document.getElementById('redirectNow');
      
      const countdownTimer = setInterval(() => {
        countdown--;
        countdownElement.textContent = countdown;
        if (countdown <= 0) {
          clearInterval(countdownTimer);
          window.location.href = 'make/index2.html';
        }
      }, 1000);
      
      // ä»Šã™ãç§»å‹•ãƒœã‚¿ãƒ³
      redirectNowBtn.addEventListener('click', () => {
        clearInterval(countdownTimer);
        window.location.href = 'make/index2.html';
      });
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    function handleLogout() {
      loginSection.style.display = 'block';
      userInfo.style.display = 'none';
      showStatus('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'info');
    }

    // Googleãƒ­ã‚°ã‚¤ãƒ³
    async function signInWithGoogle() {
      try {
        showStatus('Googleãƒ­ã‚°ã‚¤ãƒ³ä¸­...', 'info');
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        console.log('Googleãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', result.user);
      } catch (error) {
        console.error('Googleãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
        showStatus(`Googleãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
      }
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³
    async function signInWithEmail() {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      
      if (!email || !password) {
        showStatus('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      try {
        showStatus('ãƒ­ã‚°ã‚¤ãƒ³ä¸­...', 'info');
        const result = await signInWithEmailAndPassword(auth, email, password);
        console.log('ãƒ¡ãƒ¼ãƒ«ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', result.user);
        emailInput.value = '';
        passwordInput.value = '';
      } catch (error) {
        console.error('ãƒ¡ãƒ¼ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
        let errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
        
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';
            break;
          case 'auth/wrong-password':
            errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™';
            break;
          case 'auth/invalid-email':
            errorMessage = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°ãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„';
            break;
        }
        
        showStatus(errorMessage, 'error');
      }
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ–°è¦ç™»éŒ²
    async function registerWithEmail() {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      
      if (!email || !password) {
        showStatus('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      if (password.length < 6) {
        showStatus('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      try {
        showStatus('æ–°è¦ç™»éŒ²ä¸­...', 'info');
        const result = await createUserWithEmailAndPassword(auth, email, password);
        console.log('æ–°è¦ç™»éŒ²æˆåŠŸ:', result.user);
        emailInput.value = '';
        passwordInput.value = '';
      } catch (error) {
        console.error('æ–°è¦ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        let errorMessage = 'æ–°è¦ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
        
        switch (error.code) {
          case 'auth/email-already-in-use':
            errorMessage = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™';
            break;
          case 'auth/invalid-email':
            errorMessage = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
            break;
          case 'auth/weak-password':
            errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™ã€‚ã‚ˆã‚Šå¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
            break;
        }
        
        showStatus(errorMessage, 'error');
      }
    }

    // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
    async function signInAnonymous() {
      try {
        showStatus('åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ä¸­...', 'info');
        const result = await signInAnonymously(auth);
        console.log('åŒ¿åãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', result.user);
      } catch (error) {
        console.error('åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
        showStatus(`åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
      }
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    async function logout() {
      try {
        await signOut(auth);
        console.log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ');
      } catch (error) {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        showStatus(`ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    googleLoginBtn.addEventListener('click', signInWithGoogle);

    emailToggleBtn.addEventListener('click', () => {
      emailForm.style.display = emailForm.style.display === 'none' ? 'block' : 'none';
    });

    loginEmailBtn.addEventListener('click', signInWithEmail);
    registerEmailBtn.addEventListener('click', registerWithEmail);
    anonymousLoginBtn.addEventListener('click', signInAnonymous);
    logoutBtn.addEventListener('click', logout);

    // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
    emailInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') signInWithEmail();
    });
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') signInWithEmail();
    });

    // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
    onAuthStateChanged(auth, (user) => {
      if (user) {
        displayUserInfo(user);
      } else {
        handleLogout();
      }
    });

    console.log('ULTLAãƒ©ãƒœèªè¨¼ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
    showStatus('ULTLAãƒ©ãƒœã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'info');
  </script>
</body>
</html>